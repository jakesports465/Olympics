<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fantasy Olympics — Admin</title>
<style>
  :root {
    --bg:#0b0d10; --card:#12161b; --text:#e8eef4; --accent:#007bff;
  }
  body {
    background:var(--bg); color:var(--text);
    font-family:system-ui, sans-serif; margin:0; padding:20px;
  }
  h1,h2 { color:var(--accent); }
  fieldset { border:1px solid #1b232d; margin-bottom:20px; padding:10px; }
  label { display:block; margin-top:6px; }
  input,select,button {
    background:#12161b; color:#e8eef4; border:1px solid #1b232d;
    border-radius:4px; padding:6px; width:100%; box-sizing:border-box;
  }
  button {
    background:var(--accent); color:white; border:none;
    margin-top:8px; cursor:pointer; font-weight:bold;
  }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th,td { border-bottom:1px solid #1b232d; padding:6px; }
  th { background:#181c23; text-align:left; }
  tr:hover { background:#11161e; }
</style>
</head>
<body>
<h1>Fantasy Olympics Admin</h1>

<div id="status">Connecting to Supabase…</div>

<fieldset>
  <legend>Add Player</legend>
  <label>Name <input id="playerName" /></label>
  <button id="btnAddPlayer">Add Player</button>
</fieldset>

<fieldset>
  <legend>Add Pick</legend>
  <label>Player <select id="pickPlayer"></select></label>
  <label>Country <input id="pickCountry" placeholder="USA"/></label>
  <label>Discipline <input id="pickDiscipline" placeholder="Biathlon"/></label>
  <label>Multiplier <input id="pickMultiplier" type="number" step="0.1" value="1.0"/></label>
  <label>Round <input id="pickRound" type="number" value="1"/></label>
  <button id="btnAddPick">Add Pick</button>
</fieldset>

<fieldset>
  <legend>Add Result</legend>
  <label>Discipline <input id="resDiscipline" placeholder="Biathlon"/></label>
  <label>Country <input id="resCountry" placeholder="NOR"/></label>
  <label>Medal
    <select id="resMedal">
      <option value="G">Gold</option>
      <option value="S">Silver</option>
      <option value="B">Bronze</option>
    </select>
  </label>
  <button id="btnAddResult">Add Result</button>
</fieldset>

<h2>Players</h2>
<table id="tblPlayers"><thead><tr><th>Name</th></tr></thead><tbody></tbody></table>

<h2>Picks</h2>
<table id="tblPicks">
  <thead><tr><th>Player</th><th>Country</th><th>Discipline</th><th>Multiplier</th><th>Round</th></tr></thead>
  <tbody></tbody>
</table>

<h2>Results</h2>
<table id="tblResults">
  <thead><tr><th>Discipline</th><th>Country</th><th>Medal</th><th>Time Stamp</th></tr></thead>
  <tbody></tbody>
</table>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://mdreidvoocngzailutqy.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kcmVpZHZvb2NuZ3phaWx1dHF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2NDA4MDMsImV4cCI6MjA3NzIxNjgwM30.IEKZpeuNAUsI8Q1p5viw1MjAMSTZbaAREx3_1Mxr2Wc";
  const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

  const statusEl = document.getElementById("status");
  const playerSel = document.getElementById("pickPlayer");
  const tblPlayers = document.querySelector("#tblPlayers tbody");
  const tblPicks = document.querySelector("#tblPicks tbody");
  const tblResults = document.querySelector("#tblResults tbody");

  // --- Load current data ---
  async function loadAll() {
    const { data: players } = await sb.from("players").select("*").order("name");
    const { data: picks } = await sb.from("picks").select("*");
    const { data: results } = await sb.from("results").select("*").order("ts");

    // Players list
    playerSel.innerHTML = players.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
    tblPlayers.innerHTML = players.map(p=>`<tr><td>${p.name}</td></tr>`).join("");
    tblPicks.innerHTML = picks.map(p=>`
      <tr><td>${findName(p.player_id,players)}</td>
          <td>${p.country}</td><td>${p.discipline}</td>
          <td>${p.multiplier}</td><td>${p.round}</td></tr>`).join("");
    tblResults.innerHTML = results.map(r=>`
      <tr><td>${r.discipline}</td><td>${r.country}</td>
          <td>${r.medal}</td><td>${new Date(r.ts).toLocaleString()}</td></tr>`).join("");
  }

  function findName(id,arr){ const f=arr.find(x=>x.id===id); return f?f.name:"?"; }

  // --- Add Player ---
  document.getElementById("btnAddPlayer").onclick = async () => {
    const name = document.getElementById("playerName").value.trim();
    if(!name) return alert("Enter a name");
    const { error } = await sb.from("players").insert([{ name }]);
    if(error) alert(error.message); else { document.getElementById("playerName").value=""; await loadAll(); }
  };

  // --- Add Pick ---
  document.getElementById("btnAddPick").onclick = async () => {
    const player_id = playerSel.value;
    const country = document.getElementById("pickCountry").value.trim().toUpperCase();
    const discipline = document.getElementById("pickDiscipline").value.trim();
    const multiplier = parseFloat(document.getElementById("pickMultiplier").value) || 1.0;
    const round = parseInt(document.getElementById("pickRound").value) || 1;

    if(!player_id || !country || !discipline) return alert("Fill all fields");
    const { error } = await sb.from("picks").insert([{ player_id, country, discipline, multiplier, round }]);
    if(error) alert(error.message); else { clearPick(); await loadAll(); }
  };

  function clearPick(){
    document.getElementById("pickCountry").value="";
    document.getElementById("pickDiscipline").value="";
  }

  // --- Add Result ---
  document.getElementById("btnAddResult").onclick = async () => {
    const discipline = document.getElementById("resDiscipline").value.trim();
    const country = document.getElementById("resCountry").value.trim().toUpperCase();
    const medal = document.getElementById("resMedal").value;
    if(!discipline || !country) return alert("Fill discipline and country");
    const { error } = await sb.from("results").insert([{ discipline, country, medal }]);
    if(error) alert(error.message); else { clearResult(); await loadAll(); }
  };

  function clearResult(){
    document.getElementById("resDiscipline").value="";
    document.getElementById("resCountry").value="";
  }

  statusEl.textContent = "Connected to Supabase ✅";
  await loadAll();

  // auto-refresh when new medals arrive
  sb.channel("admin-results")
    .on("postgres_changes",{event:"INSERT",schema:"public",table:"results"},
      ()=>loadAll())
    .subscribe();
</script>
</body>
</html>
