<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fantasy Olympics — 2026</title>
<style>
  :root{
    --bg:#0b0d10; --card:#12161b; --text:#e8eef4; --muted:#8ea0b3;
    --accent:#0ea5e9; --br:#1b232d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px 18px;border-bottom:1px solid var(--br);background:#0f1319}
  h1{margin:0;color:var(--accent);font-size:22px}
  #status{color:var(--muted);font-size:13px;margin-top:6px}

  /* widen layout so 12 columns can actually fit */
  main{
    width:min(1800px, calc(100vw - 32px));
    margin:0 auto;
    padding:18px 0 26px;
  }

  /* tabs */
  .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:0 0 14px;padding:0 16px}
  .tab-btn{
    padding:10px 14px;border:1px solid var(--br);border-radius:10px;background:#0f141a;color:var(--text);
    cursor:pointer;font-weight:600
  }
  .tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .tab{display:none;padding:0 16px}
  .tab.active{display:block}

  /* cards + tables */
  .card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:14px}
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    background:var(--card);
    border:1px solid var(--br);
    border-radius:10px;
    overflow:hidden
  }
  th,td{padding:10px;border-bottom:1px solid var(--br);text-align:left;vertical-align:top}
  th{background:#111721;color:#b7c6d6}
  tr:hover td{background:#0f141a}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f141a;border:1px solid var(--br);font-size:12px}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:900px){ .row{grid-template-columns:1fr} }

  /* flag */
  .flag{
    display:inline-block;
    width:1.2em;
    margin-right:6px;
    filter:saturate(1.05);
    transform:translateY(1px);
  }

  /* --- Draft Board: make it fit nicely --- */
  /* lock column widths so 12 columns compress instead of blowing out */
  #tblBoard{ table-layout:fixed; }
  #tblBoard th, #tblBoard td{ padding:8px 6px; }
  #tblBoard tbody th{ width:112px; } /* Round label column */
  #tblBoard td{ width:auto; }

  /* draft board cells */
  .slot{min-width:0}
  .slot strong{
    display:block;
    font-weight:750;
    font-size:13px;
    line-height:1.15;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .slot .meta{
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
    line-height:1.25;
    display:-webkit-box;
    -webkit-box-orient:vertical;
    -webkit-line-clamp:2;   /* keep it compact */
    overflow:hidden;
  }
  .slot .chip{
    display:inline-block;
    margin-top:6px;
    padding:2px 7px;
    border:1px solid var(--br);
    border-radius:999px;
    background:#0f141a;
    font-size:10px;
    white-space:nowrap;
  }
  .nowrap{white-space:nowrap}
  .center{ text-align:center }

  /* small screens: allow horizontal scroll instead of microscopic text */
  .board-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  @media (max-width:1100px){
    #tblBoard{ min-width:1100px; } /* scroll only on smaller screens */
  }
</style>
</head>
<body>
<header>
  <h1>Fantasy Olympics — 2026</h1>
  <div id="status">Connecting to Supabase…</div>
</header>

<main>
  <div class="tabs">
    <button class="tab-btn active" data-tab="leader">Leaderboard</button>
    <button class="tab-btn" data-tab="picks">All Picks</button>
    <button class="tab-btn" data-tab="board">Draft Board</button>
    <button class="tab-btn" data-tab="results">Medal Feed</button>
  </div>

  <!-- Leaderboard -->
  <section id="tab-leader" class="tab active">
    <div class="card">
      <div class="muted">Live scoring. Gold 5 · Silver 3 · Bronze 1 (× pick multiplier)</div>
      <table id="tblLeaderboard">
        <thead>
          <tr><th>Player</th><th>Points</th><th>Gold</th><th>Silver</th><th>Bronze</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- All Picks -->
  <section id="tab-picks" class="tab">
    <div class="card">
      <div class="row">
        <div><span class="muted">Players</span>: <span id="countPlayers" class="pill">0</span></div>
        <div><span class="muted">Total Picks</span>: <span id="countPicks" class="pill">0</span></div>
        <div><span class="muted">Countries Drafted</span>: <span id="countCountries" class="pill">0</span></div>
      </div>
      <table id="tblPicks">
        <thead>
          <tr><th>Player</th><th>Country</th><th>Discipline</th><th>Multiplier</th><th>Round</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Draft Board (Snake) -->
  <section id="tab-board" class="tab">
    <div class="card">
      <div class="muted">Snake order per round. In each round, picks are ordered by insert time (earlier = lower pick #). Odd rounds go left→right; even rounds right→left.</div>
      <div class="board-wrap">
        <table id="tblBoard">
          <thead id="boardHead"></thead>
          <tbody id="boardBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Medal Feed -->
  <section id="tab-results" class="tab">
    <div class="card">
      <div class="muted">Newest first</div>
      <table id="tblResults">
        <thead>
          <tr><th>Time</th><th>Discipline</th><th>Country</th><th>Medal</th><th>Event ID</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // Supabase (your project)
  const SUPABASE_URL = "https://mdreidvoocngzailutqy.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kcmVpZHZvb2NuZ3phaWx1dHF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2NDA4MDMsImV4cCI6MjA3NzIxNjgwM30.IEKZpeuNAUsI8Q1p5viw1MjAMSTZbaAREx3_1Mxr2Wc";
  const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

  const statusEl = document.getElementById("status");
  const lbBody = document.querySelector("#tblLeaderboard tbody");
  const picksBody = document.querySelector("#tblPicks tbody");
  const resultsBody = document.querySelector("#tblResults tbody");
  const boardHead = document.getElementById("boardHead");
  const boardBody = document.getElementById("boardBody");
  const elPlayers = document.getElementById("countPlayers");
  const elPicks = document.getElementById("countPicks");
  const elCountries = document.getElementById("countCountries");

  // tabs
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("tab-"+btn.dataset.tab).classList.add("active");
    });
  });

  // scoring
  const MEDAL_POINTS = { G:5, S:3, B:1 };

  // state
  const state = { players:[], picks:[], results:[] };

  // --- Flags ---
  // Accepts NOC-like 3-letter codes (USA/CAN/etc) or 2-letter ISO (US/CA/etc)
  const NOC_TO_ISO2 = {
    USA:"US", CAN:"CA", GBR:"GB", GER:"DE", FRA:"FR", ITA:"IT", NED:"NL", SUI:"CH",
    SWE:"SE", NOR:"NO", FIN:"FI", DEN:"DK", ISL:"IS", IRL:"IE", BEL:"BE", AUT:"AT",
    ESP:"ES", POR:"PT", POL:"PL", CZE:"CZ", SVK:"SK", SLO:"SI", CRO:"HR", SRB:"RS",
    HUN:"HU", ROU:"RO", BUL:"BG", UKR:"UA", EST:"EE", LAT:"LV", LTU:"LT",
    RUS:"RU", KAZ:"KZ", UZB:"UZ", AZE:"AZ", ARM:"AM", GEO:"GE", TUR:"TR", ISR:"IL",
    CHN:"CN", JPN:"JP", KOR:"KR", PRK:"KP", MGL:"MN", TPE:"TW", HKG:"HK",
    AUS:"AU", NZL:"NZ",
    BRA:"BR", ARG:"AR", CHI:"CL", COL:"CO", PER:"PE", ECU:"EC", VEN:"VE", URU:"UY", MEX:"MX",
    RSA:"ZA", EGY:"EG", MAR:"MA", TUN:"TN", ALG:"DZ", NGA:"NG", KEN:"KE", ETH:"ET"
  };

  function iso2ToFlag(iso2){
    if(!iso2 || typeof iso2 !== "string") return "";
    const s = iso2.trim().toUpperCase();
    if (s.length !== 2) return "";
    const A = 0x1F1E6;
    const code1 = s.charCodeAt(0) - 65;
    const code2 = s.charCodeAt(1) - 65;
    if(code1<0 || code1>25 || code2<0 || code2>25) return "";
    return String.fromCodePoint(A + code1, A + code2);
  }

  function countryToFlag(country){
    if(!country) return "";
    const c = String(country).trim();
    // already a flag emoji?
    if(/[\u{1F1E6}-\u{1F1FF}]/u.test(c)) return c;
    const up = c.toUpperCase();
    if (up.length === 2) return iso2ToFlag(up);
    if (NOC_TO_ISO2[up]) return iso2ToFlag(NOC_TO_ISO2[up]);
    return ""; // unknown code; keep it clean
  }

  function flagHTML(country){
    const f = countryToFlag(country);
    return f ? `<span class="flag" title="${country}">${f}</span>` : "";
  }

  // load
  async function loadAll(){
    statusEl.textContent = "Loading…";
    const [p1,p2,p3] = await Promise.all([
      sb.from("players").select("id,name").order("name"),
      sb.from("picks").select("id,player_id,country,discipline,multiplier,round").order("round").order("id"),
      sb.from("results").select("*").order("ts",{ascending:false})
    ]);
    if(p1.error) return fail(p1.error);
    if(p2.error) return fail(p2.error);
    if(p3.error) return fail(p3.error);

    state.players = p1.data || [];
    state.picks = p2.data || [];
    state.results = p3.data || [];

    renderLeaderboard();
    renderPicks();
    renderResults();
    renderDraftBoard();

    statusEl.textContent = "Live — updates automatically";
  }

  function fail(err){
    console.error(err);
    statusEl.textContent = "Error loading — check console";
    alert(err.message || "Error");
  }

  // realtime
  function subscribeRealtime(){
    // results live inserts
    sb.channel("live-results")
      .on("postgres_changes",{event:"INSERT",schema:"public",table:"results"}, payload=>{
        state.results.unshift(payload.new);
        renderResults();
        renderLeaderboard();
      }).subscribe();

    // picks live inserts (during draft)
    sb.channel("live-picks")
      .on("postgres_changes",{event:"INSERT",schema:"public",table:"picks"}, payload=>{
        state.picks.push(payload.new);
        // keep picks sorted by round,id for board
        state.picks.sort((a,b)=> (a.round-b.round) || (a.id-b.id));
        renderPicks();
        renderDraftBoard();
        renderLeaderboard();
      }).subscribe();

    // players live inserts
    sb.channel("live-players")
      .on("postgres_changes",{event:"INSERT",schema:"public",table:"players"}, payload=>{
        state.players.push(payload.new);
        state.players.sort((a,b)=>a.name.localeCompare(b.name));
        renderPicks();
        renderDraftBoard();
        renderLeaderboard();
      }).subscribe();
  }

  // leaderboard
  function renderLeaderboard(){
    const scores = {};
    for(const p of state.players){
      scores[p.id] = { name:p.name, points:0, G:0, S:0, B:0 };
    }
    for(const r of state.results){
      const matches = state.picks.filter(pk => pk.country===r.country && pk.discipline===r.discipline);
      for(const m of matches){
        const pts = (MEDAL_POINTS[r.medal]||0) * (m.multiplier||1);
        const s = scores[m.player_id];
        if(s){
          s.points += pts;
          s[r.medal] += 1;
        }
      }
    }
    const arr = Object.values(scores).sort((a,b)=>b.points-a.points || a.name.localeCompare(b.name));
    lbBody.innerHTML = arr.map(s=>`
      <tr>
        <td>${s.name}</td>
        <td>${s.points.toFixed(2)}</td>
        <td>${s.G}</td>
        <td>${s.S}</td>
        <td>${s.B}</td>
      </tr>
    `).join("") || `<tr><td colspan="5" class="muted">No players yet</td></tr>`;
  }

  // picks (flat list)
  function renderPicks(){
    elPlayers.textContent = state.players.length;
    elPicks.textContent = state.picks.length;
    const uniqueCountries = new Set(state.picks.map(p=>p.country));
    elCountries.textContent = uniqueCountries.size;

    const byPlayer = new Map(state.players.map(p=>[p.id,p.name]));
    const rows = state.picks
      .slice()
      .sort((a,b)=>{
        const an = byPlayer.get(a.player_id)||"", bn = byPlayer.get(b.player_id)||"";
        return a.round-b.round || an.localeCompare(bn) || a.discipline.localeCompare(b.discipline);
      })
      .map(p=>`
        <tr>
          <td>${byPlayer.get(p.player_id) || "?"}</td>
          <td>${flagHTML(p.country)}${p.country}</td>
          <td>${p.discipline}</td>
          <td>${(p.multiplier||1).toFixed(2)}</td>
          <td>${p.round||""}</td>
        </tr>
      `).join("");
    picksBody.innerHTML = rows || `<tr><td colspan="5" class="muted">No picks yet</td></tr>`;
  }

  // draft board (snake)
  function renderDraftBoard(){
    const players = state.players.slice(); // [{id,name}]
    const byPlayer = new Map(players.map(p=>[p.id,p.name]));

    // Determine number of teams and max rounds in data
    const numTeams = players.length || Math.max( (new Set(state.picks.map(p=>p.player_id))).size, 0 );
    const maxRound = Math.max(0, ...state.picks.map(p=>p.round || 0));

    // Figure base order from Round 1 earliest picks; fallback: alphabetical by player name
    const r1 = state.picks.filter(p=>p.round===1).sort((a,b)=>a.id-b.id);
    const orderIds = r1.length===numTeams
      ? r1.map(p=>p.player_id)
      : players.slice().sort((a,b)=>a.name.localeCompare(b.name)).map(p=>p.id);

    // Optional header row so it looks cleaner
    const headerCells = (orderIds.length ? orderIds : players.map(p=>p.id)).map(pid=>{
      const nm = byPlayer.get(pid) || "Player";
      return `<th class="nowrap" title="${nm}">${nm}</th>`;
    });
    boardHead.innerHTML = `<tr><th class="nowrap">Round</th>${headerCells.join("")}</tr>`;

    // Build a map { round -> [slots of length numTeams] } and fill via snake
    const bodyRows = [];
    for(let round=1; round<=Math.max(maxRound,1); round++){
      const rowSlots = Array.from({length:numTeams}, ()=>`<td class="slot muted">—</td>`);
      const picksThisRound = state.picks.filter(p=>p.round===round).sort((a,b)=>a.id-b.id);

      picksThisRound.forEach((pick, idxInRound)=>{
        let col = idxInRound;
        if (round % 2 === 0) col = (numTeams-1) - idxInRound; // snake reverse on even rounds
        if (col<0 || col>=numTeams) return;

        const playerName = byPlayer.get(pick.player_id) || "Player";
        rowSlots[col] = `
          <td class="slot" title="${playerName} — ${pick.country} ${pick.discipline}">
            <strong>${playerName}</strong>
            <div class="meta">${flagHTML(pick.country)}${pick.country} · ${pick.discipline} × ${(pick.multiplier||1)}</div>
            <span class="chip">R${round} · P${idxInRound+1}</span>
          </td>`;
      });

      bodyRows.push(`<tr><th class="nowrap">Round ${round}</th>${rowSlots.join("")}</tr>`);
    }
    boardBody.innerHTML = bodyRows.join("") || `<tr><td class="muted">No draft picks yet</td></tr>`;
  }

  // results (feed)
  function renderResults(){
    const rows = state.results
      .slice(0,300)
      .map(r=>`
        <tr>
          <td>${r.ts ? new Date(r.ts).toLocaleString() : "-"}</td>
          <td>${r.discipline}</td>
          <td>${flagHTML(r.country)}${r.country}</td>
          <td>${r.medal</td>
          <td class="muted">${r.event_id||"-"}</td>
        </tr>
      `).join("");
    resultsBody.innerHTML = rows || `<tr><td colspan="5" class="muted">No results yet</td></tr>`;
  }

  // init
  loadAll();
  subscribeRealtime();
</script>
</body>
</html>

