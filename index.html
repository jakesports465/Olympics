<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fantasy Olympics — 2026</title>
<style>
  :root{
    --bg:#0b0d10; --card:#12161b; --text:#e8eef4; --muted:#8ea0b3;
    --accent:#0ea5e9; --br:#1b232d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px 18px;border-bottom:1px solid var(--br);background:#0f1319}
  h1{margin:0;color:var(--accent);font-size:22px}
  #status{color:var(--muted);font-size:13px;margin-top:6px}
  main{max-width:1100px;margin:0 auto;padding:18px}

  /* tabs */
  .tabs{display:flex;gap:8px;margin:0 0 14px}
  .tab-btn{
    padding:10px 14px;border:1px solid var(--br);border-radius:10px;background:#0f141a;color:var(--text);
    cursor:pointer;font-weight:600;
  }
  .tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .tab{display:none}
  .tab.active{display:block}

  /* cards + tables */
  .card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:14px}
  table{width:100%;border-collapse:collapse;margin-top:10px;background:var(--card);border:1px solid var(--br);border-radius:10px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid var(--br);text-align:left}
  th{background:#111721;color:#b7c6d6}
  tr:hover td{background:#0f141a}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f141a;border:1px solid var(--br);font-size:12px}
  .row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:820px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <h1>Fantasy Olympics — 2026</h1>
  <div id="status">Connecting to Supabase…</div>
</header>

<main>
  <div class="tabs">
    <button class="tab-btn active" data-tab="leader">Leaderboard</button>
    <button class="tab-btn" data-tab="picks">All Picks</button>
    <button class="tab-btn" data-tab="results">Medal Feed</button>
  </div>

  <!-- Leaderboard -->
  <section id="tab-leader" class="tab active">
    <div class="card">
      <div class="muted">Live scoring. Gold 3 · Silver 2 · Bronze 1 (× pick multiplier)</div>
      <table id="tblLeaderboard">
        <thead>
          <tr><th>Player</th><th>Points</th><th>Gold</th><th>Silver</th><th>Bronze</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- All Picks -->
  <section id="tab-picks" class="tab">
    <div class="card">
      <div class="row">
        <div><span class="muted">Players</span>: <span id="countPlayers" class="pill">0</span></div>
        <div><span class="muted">Total Picks</span>: <span id="countPicks" class="pill">0</span></div>
        <div><span class="muted">Countries Drafted</span>: <span id="countCountries" class="pill">0</span></div>
      </div>
      <table id="tblPicks">
        <thead>
          <tr><th>Player</th><th>Country</th><th>Discipline</th><th>Multiplier</th><th>Round</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Medal Feed -->
  <section id="tab-results" class="tab">
    <div class="card">
      <div class="muted">Newest first</div>
      <table id="tblResults">
        <thead>
          <tr><th>Time</th><th>Discipline</th><th>Country</th><th>Medal</th><th>Event ID</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Supabase (your project)
  const SUPABASE_URL = "https://mdreidvoocngzailutqy.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kcmVpZHZvb2NuZ3phaWx1dHF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2NDA4MDMsImV4cCI6MjA3NzIxNjgwM30.IEKZpeuNAUsI8Q1p5viw1MjAMSTZbaAREx3_1Mxr2Wc";
  const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

  const statusEl = document.getElementById("status");
  const lbBody = document.querySelector("#tblLeaderboard tbody");
  const picksBody = document.querySelector("#tblPicks tbody");
  const resultsBody = document.querySelector("#tblResults tbody");
  const elPlayers = document.getElementById("countPlayers");
  const elPicks = document.getElementById("countPicks");
  const elCountries = document.getElementById("countCountries");

  // tabs
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("tab-"+btn.dataset.tab).classList.add("active");
    });
  });

  // scoring
  const MEDAL_POINTS = { G:3, S:2, B:1 };

  // state
  const state = { players:[], picks:[], results:[] };

  // load
  async function loadAll(){
    statusEl.textContent = "Loading…";
    const [p1,p2,p3] = await Promise.all([
      sb.from("players").select("id,name").order("name"),
      sb.from("picks").select("id,player_id,country,discipline,multiplier,round"),
      sb.from("results").select("*").order("ts",{ascending:false})
    ]);
    if(p1.error) return fail(p1.error);
    if(p2.error) return fail(p2.error);
    if(p3.error) return fail(p3.error);

    state.players = p1.data || [];
    state.picks = p2.data || [];
    state.results = p3.data || [];

    renderLeaderboard();
    renderPicks();
    renderResults();

    statusEl.textContent = "Live — updates automatically";
  }

  function fail(err){
    console.error(err);
    statusEl.textContent = "Error loading — check console";
    alert(err.message || "Error");
  }

  // realtime
  function subscribeRealtime(){
    // results live inserts
    sb.channel("live-results")
      .on("postgres_changes",{event:"INSERT",schema:"public",table:"results"}, payload=>{
        state.results.unshift(payload.new);
        renderResults();
        renderLeaderboard();
      }).subscribe();

    // picks live inserts (if admin adds during draft)
    sb.channel("live-picks")
      .on("postgres_changes",{event:"INSERT",schema:"public",table:"picks"}, payload=>{
        state.picks.push(payload.new);
        renderPicks();
        renderLeaderboard();
      }).subscribe();

    // players live inserts
    sb.channel("live-players")
      .on("postgres_changes",{event:"INSERT",schema:"public",table:"players"}, payload=>{
        state.players.push(payload.new);
        renderPicks();
        renderLeaderboard();
      }).subscribe();
  }

  // leaderboard
  function renderLeaderboard(){
    const scores = {};
    for(const p of state.players){
      scores[p.id] = { name:p.name, points:0, G:0, S:0, B:0 };
    }
    for(const r of state.results){
      const matches = state.picks.filter(pk => pk.country===r.country && pk.discipline===r.discipline);
      for(const m of matches){
        const pts = (MEDAL_POINTS[r.medal]||0) * (m.multiplier||1);
        const s = scores[m.player_id];
        if(s){
          s.points += pts;
          s[r.medal] += 1;
        }
      }
    }
    const arr = Object.values(scores).sort((a,b)=>b.points-a.points || a.name.localeCompare(b.name));
    lbBody.innerHTML = arr.map(s=>`
      <tr>
        <td>${s.name}</td>
        <td>${s.points.toFixed(1)}</td>
        <td>${s.G}</td>
        <td>${s.S}</td>
        <td>${s.B}</td>
      </tr>
    `).join("") || `<tr><td colspan="5" class="muted">No players yet</td></tr>`;
  }

  // picks
  function renderPicks(){
    // stats
    elPlayers.textContent = state.players.length;
    elPicks.textContent = state.picks.length;
    const uniqueCountries = new Set(state.picks.map(p=>p.country));
    elCountries.textContent = uniqueCountries.size;

    const byPlayer = new Map(state.players.map(p=>[p.id,p.name]));
    const rows = state.picks
      .slice()
      .sort((a,b)=>{
        const an = byPlayer.get(a.player_id)||"", bn = byPlayer.get(b.player_id)||"";
        return an.localeCompare(bn) || a.round - b.round || a.discipline.localeCompare(b.discipline);
      })
      .map(p=>`
        <tr>
          <td>${byPlayer.get(p.player_id) || "?"}</td>
          <td>${p.country}</td>
          <td>${p.discipline}</td>
          <td>${(p.multiplier||1).toFixed(1)}</td>
          <td>${p.round||""}</td>
        </tr>
      `).join("");
    picksBody.innerHTML = rows || `<tr><td colspan="5" class="muted">No picks yet</td></tr>`;
  }

  // results
  function renderResults(){
    const rows = state.results
      .slice(0,200) // keep it light
      .map(r=>`
        <tr>
          <td>${r.ts ? new Date(r.ts).toLocaleString() : "-"}</td>
          <td>${r.discipline}</td>
          <td>${r.country}</td>
          <td>${r.medal}</td>
          <td class="muted">${r.event_id||"-"}</td>
        </tr>
      `).join("");
    resultsBody.innerHTML = rows || `<tr><td colspan="5" class="muted">No results yet</td></tr>`;
  }

  // init
  loadAll();
  subscribeRealtime();
</script>
</body>
</html>
